# ğŸ¤– CLAUDE.md - GuÃ­a Operacional para Claude Code AI

> **WORKSPACE AUTO-CONFIGURADO** desde trivance-dev-config  
> **âš¡ HOT-RELOAD â‰¤2s ESTÃNDAR** para desarrollo ultra-rÃ¡pido

## ğŸ¯ MISSION CRITICAL - Read This First

**Este workspace estÃ¡ COMPLETAMENTE configurado y optimizado. No reinventes soluciones existentes.**

### âš¡ GOLDEN RULES (Non-Negotiable)

1. **ğŸš€ `./start.sh`** - ÃšNICO comando maestro para TODO
2. **ğŸ³ Hot-reload â‰¤2s** - ESTÃNDAR obligatorio, no opcional  
3. **ğŸ“ Multi-repo workspace** - 4 repositorios integrados
4. **ğŸ”§ trivance-dev-config** - ConfiguraciÃ³n centralizada y autoridad
5. **ğŸ‡ªğŸ‡¸ Spanish-first** - Docs y comunicaciÃ³n en espaÃ±ol

## ğŸ›¡ï¸ Critical Rules for AI

### âŒ NEVER DO THESE (Anti-Patterns)

**PROHIBIDO ABSOLUTAMENTE:**
- âŒ **Crear `start-all.sh`, `status.sh`** (eliminados por arquitectura limpia)
- âŒ **Duplicar `ENVIRONMENTS.md`** (symlink a docs/ implementado)
- âŒ **Modificar `docker-compose.dev.yml`** (configuraciÃ³n maestra intocable)
- âŒ **Ignorar documentaciÃ³n existente** (revisa SIEMPRE antes de actuar)
- âŒ **Crear archivos en workspace root** (van en trivance-dev-config/config/)
- âŒ **Generar secrets manualmente** (sistema automÃ¡tico implementado)

### âœ… ALWAYS DO THESE (Best Practices)

**OBLIGATORIO SIEMPRE:**
- âœ… **Usar `./start.sh`** (comando unificado)
- âœ… **Leer README.md antes de actuar** (fuente de verdad)
- âœ… **Verificar carpeta templates** antes de crear archivos
- âœ… **Respetar arquitectura multi-repo** (no mono-repo)
- âœ… **Documentar en espaÃ±ol** (equipo hispano-hablante)
- âœ… **Preservar hot-reload â‰¤2s** (estÃ¡ndar de productividad)

## ğŸ—ï¸ Comandos Principales

### ğŸš€ Comando Maestro
```bash
# COMANDO PRINCIPAL con menÃº interactivo
./start.sh

# Comandos directos
./start.sh start   # ğŸš€ ESTÃNDAR: Docker + hot-reload â‰¤2s
./start.sh stop    # ğŸ›‘ Detener todos los servicios
./start.sh status  # ğŸ“Š Ver estado del sistema
./start.sh setup   # ğŸ”§ Reconfigurar desde cero

# âš¡ IMPORTANTE: Hot-reload â‰¤2s es el ESTÃNDAR, no opcional
```

### ğŸ³ Docker Development Mode (NUEVA FUNCIONALIDAD)
```bash
# Comando mÃ¡gico - Una sola lÃ­nea para desarrollo completo
./start.sh docker-dev

# O directamente con Smart Docker Manager
cd trivance-dev-config/scripts/utils
./smart-docker-manager.sh dev ../../docker/docker-compose.dev.yml
```

#### CaracterÃ­sticas del Docker Dev Mode
- âš¡ **Hot-reload â‰¤2s**: Cambios visibles instantÃ¡neamente
- ğŸ³ **Containers optimizados**: Multi-stage Dockerfiles con cache inteligente
- ğŸ“Š **Observabilidad integrada**: Log Viewer automÃ¡tico en puerto 4000
- ğŸ›¡ï¸ **Error prevention**: Warnings filtrados, feedback visual claro
- ğŸ”„ **Context optimization**: Build context reducido 95% (.dockerignore)

### URLs de Servicios (Desarrollo Local)
- Frontend Admin: http://localhost:5173
- API Principal: http://localhost:3000
- GraphQL Playground: http://localhost:3000/graphql
- API Auth: http://localhost:3001
- Swagger Auth: http://localhost:3001/api-docs
- **ğŸ” Log Viewer**: **http://localhost:4000** (Sistema de observabilidad unificado)
- Dozzle (Monitor logs): http://localhost:9999
- Prisma Studio: http://localhost:5555

## ğŸ”§ Testing por Repositorio
```bash
# Backend API (ms_level_up_management)
cd ms_level_up_management
npm test              # Unit tests con Jest
npm run test:watch    # Tests en modo watch
npm run test:cov      # Tests con cobertura
npm run test:e2e      # Tests end-to-end

# Auth Service (ms_trivance_auth)
cd ms_trivance_auth
npm test              # Unit tests con Jest
npm run test:watch    # Tests en modo watch
npm run test:cov      # Tests con cobertura

# Frontend (level_up_backoffice)
cd level_up_backoffice
npm test              # Tests con Vitest

# Mobile App (trivance-mobile) - NO tiene npm test
cd trivance-mobile
npm run type-check    # TypeScript validation
npm run lint          # ESLint validation
npm run format:check  # Prettier validation
```

## ğŸ¨ Lint y Formateo
```bash
# Backend services
npm run lint          # ESLint con auto-fix
npm run format        # Prettier

# Frontend
npm run lint          # ESLint

# Mobile
npm run lint          # ESLint
npm run lint:fix      # ESLint con auto-fix
npm run format        # Prettier
npm run format:check  # Verificar formato
npm run type-check    # TypeScript check
```

## ğŸ—„ï¸ Base de Datos (Prisma)
```bash
cd ms_level_up_management
npx prisma migrate dev    # Crear nueva migraciÃ³n
npx prisma generate       # Generar cliente Prisma
npx prisma studio         # GUI para explorar DB
npx prisma db push        # Sincronizar schema sin migraciÃ³n
```

## ğŸ›ï¸ GestiÃ³n de Environments
```bash
# Ver environment actual
./trivance-dev-config/scripts/envs.sh status

# Cambiar environment
./trivance-dev-config/scripts/envs.sh switch local       # Desarrollo local
./trivance-dev-config/scripts/envs.sh switch qa          # QA
./trivance-dev-config/scripts/envs.sh switch production  # ProducciÃ³n

# Validar configuraciÃ³n
./trivance-dev-config/scripts/envs.sh validate local
```

## ğŸ—ï¸ Arquitectura del Sistema

### Flujo de ComunicaciÃ³n
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Backoffice    â”‚â”€â”€â”€â”€â–¶â”‚  Management API â”‚â”€â”€â”€â”€â–¶â”‚   PostgreSQL    â”‚
â”‚  (Port: 5173)   â”‚     â”‚  (Port: 3000)   â”‚     â”‚  (Port: 5432)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚                       â”‚ GraphQL
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mobile App     â”‚â”€â”€â”€â”€â–¶â”‚    Auth API     â”‚â”€â”€â”€â”€â–¶â”‚    MongoDB      â”‚
â”‚   (Expo Dev)    â”‚     â”‚  (Port: 3001)   â”‚     â”‚  (Port: 27017)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Arquitectura Multi-tenant
- **Aislamiento de datos**: Por `organizationId` en todas las tablas
- **Permisos granulares**: Sistema de roles y permisos por organizaciÃ³n
- **Contexto de usuario**: JWT contiene `organizationId` y permisos

### Stack TecnolÃ³gico
- **Backend**: NestJS + TypeScript + Prisma (PostgreSQL) + Mongoose (MongoDB)
- **Frontend**: React 18 + Vite + Redux Toolkit + Tailwind CSS
- **Mobile**: React Native + Expo + Redux Persist
- **Infraestructura**: Docker + PM2 + Nginx (producciÃ³n)
- **Testing**: Jest (backend) + Vitest (frontend)
- **Monitoreo**: Sentry + Dozzle (logs Docker)

## ğŸ¨ Patrones de CÃ³digo

### NestJS Service Pattern
```typescript
@Injectable()
export class EntityService {
  constructor(
    private prisma: PrismaService,
    private readonly relatedService: RelatedService
  ) {}

  async findAll(organizationId: string, query: QueryDto) {
    return this.prisma.entity.findMany({
      where: { organizationId, ...query },
      include: { relations: true }
    });
  }
}
```

### React Component Pattern
```typescript
interface ComponentProps {
  data: DataType;
  onAction: (id: string) => void;
}

export const Component: React.FC<ComponentProps> = ({ data, onAction }) => {
  // Hooks primero
  const dispatch = useAppDispatch();
  const { isLoading } = useAppSelector(selectState);
  
  // LÃ³gica del componente
  const handleClick = useCallback(() => {
    onAction(data.id);
  }, [data.id, onAction]);
  
  // Render condicional
  if (isLoading) return <Spinner />;
  
  return <div>{/* JSX */}</div>;
};
```

## ğŸ” Sistema de Observabilidad

### Log Viewer Unificado (Puerto 4000)
```bash
# Iniciar Log Viewer
./trivance-dev-config/scripts/utils/start-log-viewer.sh

# Acceder al sistema
open http://localhost:4000

# API para consultas programÃ¡ticas
curl "http://localhost:4000/api/logs/search?level=error&limit=20" | jq
curl "http://localhost:4000/api/logs/search?sessionId=abc-123" | jq
curl "http://localhost:4000/api/logs/search?text=unauthorized" | jq

# Filtros disponibles:
# - service: frontend, backend, auth
# - level: error, warn, info, debug
# - traceId: seguimiento de requests
# - sessionId: seguimiento de sesiones
# - text: bÃºsqueda de texto completo
```

## ğŸš¨ Troubleshooting

### ğŸ”§ Smart Docker Manager
```bash
# Usar Smart Docker Manager para evitar falsos errores de timeout
cd trivance-dev-config/scripts/utils

# Operaciones con timeouts adaptativos
./smart-docker-manager.sh up compose_file services     # 600s para first_build, 180s para startup
./smart-docker-manager.sh down compose_file           # 60s para operaciones rÃ¡pidas
./smart-docker-manager.sh restart compose_file        # 300s para rebuild
./smart-docker-manager.sh health_check compose_file   # 120s con mÃºltiples reintentos

# Ventajas del Smart Manager:
# - Timeouts adaptativos segÃºn el contexto (primera compilaciÃ³n vs reinicio)
# - Feedback visual para eliminar sensaciÃ³n de errores falsos
# - ValidaciÃ³n robusta de dependencias y comandos
# - Compatibilidad con macOS (gtimeout vs timeout)
```

### ğŸ› ï¸ Debugging
```bash
# Sistema de Observabilidad Unificado (RECOMENDADO)
open http://localhost:4000  # Log Viewer con filtros avanzados

# Logs en tiempo real
pm2 logs backoffice          # Frontend logs
docker logs -f trivance_mgmt_dev  # Backend logs
docker logs -f trivance_auth_dev  # Auth logs

# Monitor visual de logs Docker
open http://localhost:9999   # Dozzle - interfaz web moderna

# Acceso a bases de datos
docker exec -it trivance_postgres_dev psql -U trivance_dev -d trivance_development
docker exec -it trivance_mongodb_dev mongosh

# Debug NestJS
cd ms_level_up_management
npm run start:debug  # Attach debugger en puerto 9229
```

## ğŸ“š Notas Importantes

### âš ï¸ Reglas de Arquitectura
- **Docker obligatorio**: Sistema requiere Docker para backends y DBs
- **Smart Docker Manager**: Previene timeouts falsos con gestiÃ³n inteligente
- **Sistema de Observabilidad**: Log Viewer unificado en puerto 4000
- **Secrets automÃ¡ticos**: Se generan en `trivance-dev-config/config/.trivance-secrets` (no commitear)
- **Multi-tenant**: Todas las queries deben filtrar por `organizationId`
- **EspaÃ±ol en docs**: DocumentaciÃ³n y comentarios en espaÃ±ol, cÃ³digo en inglÃ©s
- **Hot-reload**: Frontend (Vite) y backends (NestJS) con recarga automÃ¡tica

## âš ï¸ COMMAND VALIDATION PARA CLAUDE

**ANTES de ejecutar cualquier comando, Claude DEBE validar:**

```bash
# 1. Verificar que servicios Docker estÃ©n activos
docker ps --filter "name=trivance" --format "table {{.Names}}\t{{.Status}}"

# 2. Verificar estado del sistema completo
./start.sh status

# 3. Si comando falla, usar troubleshooting
./start.sh --help  # Ver comandos disponibles
```

### ğŸš¨ ERROR PATTERNS PARA CLAUDE

**Si encuentras estos errores, usa estas soluciones:**

| Error | SoluciÃ³n Inmediata |
|-------|-------------------|
| `docker: command not found` | Verificar Docker Desktop activo |
| `Port already in use` | `./start.sh stop && ./start.sh start` |
| `Hot-reload >2s` | Verificar volÃºmenes Docker en docker-compose |
| `npm test fails` | Verificar que dependencias estÃ©n instaladas |
| `Database connection error` | Verificar containers PostgreSQL/MongoDB activos |

### ğŸ”— DocumentaciÃ³n Especializada
Toda la documentaciÃ³n estÃ¡ centralizada en `trivance-dev-config/`:
- **README.md** - Fuente de verdad maestra y arquitectura completa
- **docs/DOCKER.md** - GuÃ­a completa Docker y contenedores
- **docs/ENVIRONMENTS.md** - Sistema completo de environments
- **docs/TROUBLESHOOTING.md** - SoluciÃ³n de problemas y debugging

---

## ğŸ¯ TEMPLATE AUTO-SINCRONIZADO

**âš ï¸ IMPORTANTE**: Este archivo es **GENERADO AUTOMÃTICAMENTE**

- ğŸ”§ **Fuente**: `trivance-dev-config/templates/core/CLAUDE.md.template`
- ğŸ¤– **Generado por**: Script `setup.sh` 
- ğŸ”„ **Auto-update**: Cada vez que se ejecuta setup
- ğŸŒŸ **Optimizado para**: Claude Code con workspace multi-repo en espaÃ±ol

**Para modificar, edita el template y ejecuta `./trivance-dev-config/setup.sh`**